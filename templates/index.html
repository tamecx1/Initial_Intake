<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TSO Intake Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    #chat-container {
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #messages {
      min-height: 60vh;
      max-height: 70vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .bubble {
      padding: 10px 14px;
      border-radius: 12px;
      margin: 8px 0;
      max-width: 90%;
    }
    .bot {
      background: #e6eef7;
      align-self: flex-start;
      color: #003366;
      font-weight: 600;
    }
    .user {
      background: #003366;
      color: #ffffff;
      align-self: flex-end;
      margin-left: auto;
    }
    #input-area {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    #input-field {
      flex: 1;
      padding: 10px;
      font-size: 14px;
    }
    #send-btn {
      padding: 10px 16px;
      font-size: 14px;
      background: #003366;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #send-btn:hover {
      background: #002244;
    }
    .options {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .option-btn {
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid #003366;
      background: #ffffff;
      cursor: pointer;
      font-size: 13px;
    }
    .option-btn:hover {
      background: #e6eef7;
    }
  </style>
</head>

<body>
<div id="chat-container">
  <div id="messages"></div>

  <div id="input-area">
    <input id="input-field" type="text" placeholder="Type your answer..." autocomplete="off">
    <button id="send-btn">Send</button>
  </div>
</div>

<script>
  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("input-field");
  const sendBtn = document.getElementById("send-btn");

  let projectId = null;
  let currentStep = 0;

  const answers = {
    project_id: "",
    company_name: "",
    contact_name: "",
    email: "",
    phone: "",
    location: "",
    estimated_order_date: "",
    estimated_start_of_production: "",
    pcb_processing: "",
    max_pcb_size_category: "",
    max_pcb_width_tier: "",
    max_pcb_length_tier: "",
    min_pcb_size_category: "",
    component_package_types: "",
    demanding_conditions: "",
    oem_nitrogen: "",
    files_provided: "No",
    file_links: ""
  };

  function addMessage(text, from="bot") {
    const div = document.createElement("div");
    div.classList.add("bubble", from);
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function addOptions(options) {
    const wrap = document.createElement("div");
    wrap.classList.add("options");
    options.forEach(opt => {
      const btn = document.createElement("button");
      btn.classList.add("option-btn");
      btn.textContent = opt.label;
      btn.onclick = () => {
        handleUserResponse(opt.value, true);
        wrap.remove();
      };
      wrap.appendChild(btn);
    });
    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function handleUserResponse(text, fromButton=false) {
    if (!fromButton) {
      text = text.trim();
      if (!text) return;
    }
    addMessage(text, "user");
    inputEl.value = "";
    processAnswer(currentStep, text);
    currentStep++;
    nextStep();
  }

  async function start() {
    try {
      const res = await fetch("/new_project");
      const data = await res.json();
      projectId = data.project_id;
      answers.project_id = projectId;

      addMessage("Welcome! I'll guide you through a quick set of questions so we can prepare a preliminary SMT line configuration for your project. You can stop and return anytime using your Project ID.");
      addMessage(`Your Project ID is: ${projectId}`);
      addMessage("Even with minimal information, we will generate a solution that can be oriented toward a specific product or designed with flexibility to support future assemblies. From the full universe of possible configurations, our goal is to reduce the uncertainty and move as close as possible to your real manufacturing needs—without limiting your options to a single product. We'll work together to identify the best solution for your operation.");
      nextStep();
    } catch (e) {
      console.error(e);
      addMessage("There was a problem initializing the project. Please try again later.");
    }
  }

  function nextStep() {
    switch (currentStep) {
      case 0:
        addMessage("What is your Company Name?");
        break;
      case 1:
        addMessage("What is your name?");
        break;
      case 2:
        addMessage("What is your email?");
        break;
      case 3:
        addMessage("Phone (optional):");
        break;
      case 4:
        addMessage("City, State, Country:");
        break;
      case 5:
        addMessage("When do you expect to release an order for this project?");
        break;
      case 6:
        addMessage("And when do you expect production to begin?");
        break;
      case 7:
        addMessage("Each time this project is accessed, we will revisit your estimated start of production to ensure the configuration remains aligned with your timeline.");
        break;
      case 8:
        addMessage("Is your PCB processed on one side only, or on both sides?");
        addOptions([
          { label: "Single-sided PCB", value: "Single-sided" },
          { label: "Double-sided PCB", value: "Double-sided" },
          { label: "Not sure yet", value: "Not specified" }
        ]);
        break;
      case 9:
        addMessage("How does your production environment require you to limit the maximum board size capacity on your new SMT line?");
        addOptions([
          { label: "Up to 330 × 250 mm", value: "Up to 330 × 250 mm" },
          { label: "Up to 440 × 330 mm", value: "Up to 440 × 330 mm" },
          { label: "Up to 460 × 460 mm", value: "Up to 460 × 460 mm" },
          { label: "Larger than 460 mm", value: "Larger than 460 mm" }
        ]);
        break;
      case 10:
        if (answers.max_pcb_size_category === "Larger than 460 mm") {
          addMessage("What is the max PCB width to be set in your new SMT line?");
          addOptions([
            { label: "Below 510 mm", value: "Below 510 mm" },
            { label: "Below 610 mm", value: "Below 610 mm" },
            { label: "Greater than 610 mm", value: "Greater than 610 mm" }
          ]);
        } else {
          currentStep++;
          nextStep();
        }
        break;
      case 11:
        if (answers.max_pcb_size_category === "Larger than 460 mm") {
          addMessage("What is the max PCB length to be set in your new SMT line?");
          addOptions([
            { label: "Below 510 mm", value: "Below 510 mm" },
            { label: "Below 610 mm", value: "Below 610 mm" },
            { label: "Greater than 610 mm", value: "Greater than 610 mm" }
          ]);
        } else {
          currentStep++;
          nextStep();
        }
        break;
      case 12:
        addMessage("How does your production environment require you to limit the minimum board size capacity on your new SMT line?");
        addOptions([
          { label: "70 × 100 mm", value: "70 × 100 mm" },
          { label: "Smaller than 70 × 100 mm", value: "Smaller than 70 × 100 mm" },
          { label: "Not sure yet", value: "Not specified" }
        ]);
        break;
      case 13:
        addMessage("Does your product use any of these component types? You can type a comma-separated list: QFN, BGA, LCC, 0402, None, Not sure.");
        break;
      case 14:
        addMessage("Will the products to be assembled in your new SMT line operate in demanding conditions such as vibration, high temperatures, continuous use, outdoor exposure, human-safety applications, or environments requiring long-term reliability?");
        addOptions([
          { label: "Yes", value: "Yes" },
          { label: "No", value: "No" },
          { label: "Not sure", value: "Not sure" }
        ]);
        break;
      case 15:
        addMessage("Has your OEM specified that this process must be done using Nitrogen for reflow?");
        addOptions([
          { label: "Yes", value: "Yes" },
          { label: "No", value: "No" },
          { label: "Not sure", value: "Not sure" }
        ]);
        break;
      case 16:
        addMessage("You may upload floor layout, photos, or reference files if available. If you have any links (for example to cloud storage), please paste them here now. If not, just type 'None'.");
        break;
      case 17:
        addMessage("Thank you. Preparing your preliminary summary and sending the intake to TSO...");
        submitAnswers();
        break;
      default:
        break;
    }
  }

  function processAnswer(step, text) {
    switch (step) {
      case 0: answers.company_name = text; break;
      case 1: answers.contact_name = text; break;
      case 2: answers.email = text; break;
      case 3: answers.phone = text; break;
      case 4: answers.location = text; break;
      case 5: answers.estimated_order_date = text; break;
      case 6: answers.estimated_start_of_production = text; break;
      case 8: answers.pcb_processing = text; break;
      case 9: answers.max_pcb_size_category = text; break;
      case 10:
        if (answers.max_pcb_size_category === "Larger than 460 mm")
          answers.max_pcb_width_tier = text;
        break;
      case 11:
        if (answers.max_pcb_size_category === "Larger than 460 mm")
          answers.max_pcb_length_tier = text;
        break;
      case 12: answers.min_pcb_size_category = text; break;
      case 13: answers.component_package_types = text; break;
      case 14: answers.demanding_conditions = text; break;
      case 15: answers.oem_nitrogen = text; break;
      case 16:
        if (text.toLowerCase() === "none") {
          answers.files_provided = "No";
          answers.file_links = "";
        } else {
          answers.files_provided = "Yes";
          answers.file_links = text;
        }
        break;
      default:
        break;
    }
  }

  async function submitAnswers() {
    try {
      const res = await fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(answers)
      });
      const data = await res.json();
      if (data.status === "ok") {
        addMessage("Your intake has been saved and sent to TSO. Thank you!");
      } else {
        addMessage("There was an issue submitting your intake. Please try again later.");
      }
    } catch (e) {
      console.error(e);
      addMessage("There was an issue submitting your intake. Please try again later.");
    }
  }

  sendBtn.onclick = () => handleUserResponse(inputEl.value, false);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      handleUserResponse(inputEl.value, false);
    }
  });

  start();
</script>

</body>
</html>
